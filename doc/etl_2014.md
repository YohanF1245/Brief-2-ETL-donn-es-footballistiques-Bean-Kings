# Documentation du nettoyage pour 2014
## Appercu des données
```py
print(df.describe(include='all'))
```
Intéressant pour les deux premières lignes notamemnt
| Stat | Year | Datetime | Stage | Stadium | City | Home Team Name | Home Team Goals | Away Team Goals | Away Team Name | Win conditions | Attendance | Half-time Home Goals | Half-time Away Goals | Referee | Assistant 1 | Assistant 2 | RoundID | MatchID | Home Team Initials | Away Team Initials |
|------|------|----------|-------|---------|------|----------------|-----------------|-----------------|----------------|----------------|------------|----------------------|----------------------|---------|-------------|-------------|---------|---------|--------------------|--------------------|
| count | 80.0 | 80 | 80 | 80 | 80 | 80 | 80.000000 | 80.000000 | 80 | 80 | 78.000000 | 80.000000 | 80.000000 | 80 | 80 | 80 | 80.000000 | 8.000000e+01 | 80 | 80 |
| unique | NaN | 58 | 13 | 12 | 12 | 32 | NaN | NaN | 32 | 8 | NaN | NaN | NaN | 25 | 26 | 26 | NaN | NaN | 32 | 32 |
| top | NaN | 08 Jul 2014 - 17:00 | Round of 16 | Estadio Nacional | Brasilia | Brazil | NaN | NaN | Germany | NaN | NaN | NaN | NaN | Nicola RIZZOLI (ITA) | Renato FAVERANI (ITA) | Andrea STEFANI (ITA) | NaN | NaN | BRA | GER |
| freq | NaN | 2 | 16 | 10 | 10 | 10 | NaN | NaN | 5 | 64 | NaN | NaN | NaN | 6 | 6 | 6 | NaN | NaN | 10 | 5 |
| mean | 2014.0 | NaN | NaN | NaN | NaN | NaN | 1.237500 | 1.337500 | NaN | NaN | 55374.910256 | 0.350000 | 0.575000 | NaN | NaN | NaN | 255939.750000 | 3.001865e+08 | NaN | NaN |
| std | 0.0 | NaN | NaN | NaN | NaN | NaN | 0.957895 | 1.574671 | NaN | NaN | 12417.106382 | 0.575887 | 1.028394 | NaN | NaN | NaN | 10.891293 | 1.828045e+01 | NaN | NaN |
| min | 2014.0 | NaN | NaN | NaN | NaN | NaN | 0.000000 | 0.000000 | NaN | NaN | 37603.000000 | 0.000000 | 0.000000 | NaN | NaN | NaN | 255931.000000 | 3.001865e+08 | NaN | NaN |
| 25% | 2014.0 | NaN | NaN | NaN | NaN | NaN | 0.000000 | 0.000000 | NaN | NaN | 41242.000000 | 0.000000 | 0.000000 | NaN | NaN | NaN | 255931.000000 | 3.001865e+08 | NaN | NaN |
| 50% | 2014.0 | NaN | NaN | NaN | NaN | NaN | 1.000000 | 1.000000 | NaN | NaN | 57768.500000 | 0.000000 | 0.000000 | NaN | NaN | NaN | 255931.000000 | 3.001865e+08 | NaN | NaN |
| 75% | 2014.0 | NaN | NaN | NaN | NaN | NaN | 2.000000 | 2.000000 | NaN | NaN | 66471.750000 | 1.000000 | 1.000000 | NaN | NaN | NaN | 255951.000000 | 3.001865e+08 | NaN | NaN |
| max | 2014.0 | NaN | NaN | NaN | NaN | NaN | 4.000000 | 7.000000 | NaN | NaN | 74738.000000 | 3.000000 | 5.000000 | NaN | NaN | NaN | 255959.000000 | 3.001865e+08 | NaN | NaN |


## Enlever les colonnes inutiles
```py
df = df.drop(columns=["Year", "Stadium", "Attendance", "Half-time Home Goals", "Half-time Away Goals", "Referee", "Assistant 1", "Assistant 2","RoundID"  ,  "MatchID","Home Team Initials", "Away Team Initials"])
```
## Sécuriser les types de données
### Date et heure du match
```py
df["Datetime"] = pd.to_datetime(
    df["Datetime"],
    errors="coerce"
    )
```
### But de l'équipe à domicile
```py
df["Home Team Goals"] = pd.to_numeric(
    df["Home Team Goals"],
    errors="coerce"
)
```
### But de l'équipe à l'éxterieur
```py
df["Away Team Goals"] = pd.to_numeric(
    df["Away Team Goals"],
    errors="coerce"
)
```
## Suppression des doublons
```py
df = df.drop_duplicates(df)
```
## Création des colonnes pour les fin de match au penaltys
### Enlever les espaces
```py
df["Win conditions"] = df["Win conditions"].str.strip().str.replace(" ", "")
```
### Extraire le score sous la forme (x1-x2)
```py
df["Win conditions"] = df["Win conditions"].str.extract(r"(\d+-\d+)")
```
### Créer deux colones pour stocker les buts de l'équipe home / away
```py
df[["Score home", "Score away"]] = df["Win conditions"].str.split(
    "-", 
    expand=True)
    .astype("Int64") 
```
## Déterminer les winner / losers
### Initialiser 2 colonnes en draw
```py
df["Home result"] = "draw"
df["Away result"] = "draw"
```
### Comparer les scores dans le temps réglementaire
2 booleans true / false pour determiner si c'est home ou away qui win
```py
home_win = df["Home Team Goals"] > df["Away Team Goals"]
away_win = df["Away Team Goals"] > df["Home Team Goals"]
```
### Masque boléen pour inserer les valeurs
Si home_win est true on remplace les drawn par winner / looser 
Si away_win est true on remplace les draw par loser / winner
```py
df.loc[home_win, ["Home result", "Away result"]] = ["winner", "loser"]
df.loc[away_win, ["Home result", "Away result"]] = ["loser", "winner"]
```
### Regarder si égalité a la fin du temps réglementaire
```py
draw = df["Home Team Goals"] == df["Away Team Goals"]
```
### Mask booléen pour défineur le vaingueur si penalty
si draw = true, check le nombre de penalty le plus elevé et insere winner / loser ou loser / winner
```py
df.loc[draw & (df["Score home"] > df["Score away"]),
       ["Home result", "Away result"]] = ["winner", "loser"]

df.loc[draw & (df["Score away"] > df["Score home"]),
       ["Home result", "Away result"]] = ["loser", "winner"]
```
### Normalisation des noms
normalisation des variables villes , nom équipe et stage en accord avec le document ETL_RULES.md
```py
df["Stage"] = df["Stage"].apply(normalize_stage)

df["City"] = df["City"].apply(city_to_english)

df["Home Team Name"] = df["Home Team Name"].apply(normalize_country)
df["Away Team Name"] = df["Away Team Name"].apply(normalize_country)

def clean_text(value, default="Unknown"):
    if pd.isna(value) or str(value).strip() == "":
        logger.warning("Valeur manquante remplacée par %s", default)
        return default

    value = str(value).strip().lower()
    value = unidecode(value)
    return value

def city_to_english(city):
    if pd.isna(city) or str(city).strip() == "":
        logger.warning("Ville manquante")
        return "unknown"

    city_clean = unidecode(str(city)).lower().strip()

    for c in cities.values():
        c_name = unidecode(c["name"]).lower().strip()
        if c_name == city_clean:
            return c_name

    return city_clean 

def normalize_stage(stage):
    if pd.isna(stage):
        return "unknown"

    key = unidecode(stage).lower().strip()
    key = key.replace("_", " ").replace("-", " ")

    return STAGE_MAP.get(key, key)

def normalize_country(name):
    if pd.isna(name) or str(name).strip() == "":
        logger.warning("Pays manquant → unknown")
        return "unknown"

    key = unidecode(str(name)).lower().strip()

    if key in COUNTRY_FIX_MAP:
        return COUNTRY_FIX_MAP[key]

    logger.warning("Pays hors référentiel officiel : %s", name)
    return key
```